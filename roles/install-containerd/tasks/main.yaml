---
- name: Add the [overlay] and [br_netfilter]  modules
  modprobe:
    name: "{{ item }}"
    state: present
  with_items:
    - overlay
    - br_netfilter

- name: Setup required sysctl params, these persist across reboots
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
    sysctl_file: /etc/sysctl.d/99-kubernetes-cri.conf
  with_items:
    - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { name: 'net.ipv4.ip_forward', value: '1' }
    - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }

- name: Install packages to allow apt to use a repository over HTTPS
  apt:
    name: ['apt-transport-https', 'ca-certificates', 'curl', 'software-properties-common']
    state: latest
    update_cache: yes
- name: Add Dockerâ€™s official GPG key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

- name: Add Docker apt repository
  apt_repository:
    repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable
    state: present
    update_cache: yes

- name: Install containerd
  apt:
    name: containerd.io
    state: latest
    update_cache: yes

- name: Create /etc/containerd directory
  file:
    path: /etc/containerd
    state: directory

- name: Configure containerd
  copy:
    src: config.toml
    dest: /etc/containerd/config.toml
  notify:
    - restart containerd

- name: Start Containerd
  systemd:
    state: started
    name: containerd  
